{% extends 'ShopMainBundle:Default:layout.html.twig' %}

{% block title %}{{ proposal.seoTitle|default(proposal.title) }}{% endblock %}
{% block description %}{{ proposal.seoDescription|default(proposal.shortDescription) }}{% endblock %}
{% block keywords %}{{ proposal.seoKeywords }}{% endblock %}

{% block main_container %}

    <div class="proposal-container row well-v">

        <div class="single-proposal single-proposal-{{ proposal.id }}">

            <div class="row">
                <div class="three columns">

                    {% include('ShopMainBundle:Default:shopCart.html.twig') %}
                    {% include('ShopCatalogBundle:Default:categoryLeftBar.html.twig') %}

                </div>
                <div class="nine columns">

                    <div style="margin-left: 20px">

                        <div class="proposal-breadcrumb">
                            <ul>
                                <li>
                                    <a href="{{ path('shop_catalog_category', {'slug' : category.slug}) }}">{{ category.name|capitalize }}</a>
                                    <span class="delimiter">/</span>
                                </li>
                                <li>
                                    <h1 class="proposal-title title current">
                                        {{ proposal.title|nl2br }}
                                    </h1>
                                </li>
                            </ul>
                        </div>

                        <table class="proposal-header-table">
                            <tbody>
                                <tr>
                                    <td class="image-cell">
                                        <div class="proposal-image">
                                            <a href="{{ proposal.image_url }}" class="fancybox" rel="proposalImages">
                                                <img src="{{ proposal.thumb_image_url }}">
                                            </a>
                                        </div>
                                        <div style="margin-top: 5px; text-align: center">
                                            {% set imageUrls = [] %}
                                            {% if proposal.images|length > 1 %}
                                                {% for image in proposal.images %}
                                                    {% set imageUrls = imageUrls|merge([image.url]) %}
                                                    <a href="{{ image.url }}" class="fancybox" rel="proposalImages" style="display: none;">
                                                        <img src="{{ image.thumb_url }}">
                                                    </a>
                                                {% endfor %}
                                                <a href="#" onclick="$.fancybox.open({{ imageUrls|json_encode }}, {openEffect: 'none', closeEffect: 'none', padding: 0, loop : false, helpers: {overlay: {locked: false}}}); return false;">
                                                    Просмотреть фотографии
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="price-cell">

                                        {% if price %}
                                            <div class="order-proposal-form-container">

                                                <div class="proposal-price-container">
                                                    {% if price %}
                                                        <div class="price">
                                                            {#{{ priceData.maxPrice }}#}
                                                            {% if priceData.maxPrice > priceData.price %}
                                                                от
                                                            {% endif %}
                                                            {{ priceData.price|shop_price }}
                                                        </div>
                                                        <div>
                                                            {% set proposalPriceShippingSummary = priceData.shipping.shippingSummaries|first %}
                                                            <div>
                                                                Доставка:
                                                                {% if proposalPriceShippingSummary.shippingPrice.value %}
                                                                    {{ proposalPriceShippingSummary.shippingPrice|weasty_price }}
                                                                {% else %}
                                                                    бесплатно
                                                                {% endif %}
                                                                ({{ priceData.shipping.city.getLocaleName(app.request.locale) }})
                                                            </div>
                                                            {#{% if proposalPriceShippingSummary.liftingPrice %}#}
                                                                {#<div>#}
                                                                    {#Подъем на этаж:#}
                                                                    {#{% if proposalPriceShippingSummary.liftingPrice.value %}#}
                                                                        {#{{ proposalPriceShippingSummary.liftingPrice|weasty_price }}#}
                                                                    {#{% else %}#}
                                                                        {#бесплатно#}
                                                                    {#{% endif %}#}
                                                                {#</div>#}
                                                            {#{% endif %}#}
                                                            {#{% if proposalPriceShippingSummary.assemblyPrice %}#}
                                                                {#<div>#}
                                                                    {#Сборка:#}
                                                                    {#{% if proposalPriceShippingSummary.assemblyPrice.value %}#}
                                                                        {#{{ proposalPriceShippingSummary.assemblyPrice|weasty_price }}#}
                                                                    {#{% else %}#}
                                                                        {#бесплатно#}
                                                                    {#{% endif %}#}
                                                                {#</div>#}
                                                            {#{% endif %}#}
                                                        </div>
                                                    {% endif %}
                                                </div>

                                                {% if price.id not in shopCart.priceIds %}
                                                    <a href="#" class="add-to-cart" data-cart='{"categoryId":{{ proposal.categoryId }},"proposalId":{{ proposal.id }},"priceId":{{ price.id }}}'>
                                                        Добавить в корзину
                                                    </a>
                                                    {% if proposal.categoryId in shopCart.categories|keys and shopCart.categories[proposal.categoryId].proposals|length == 1 %}
                                                        <a href="#" class="add-to-cart remove-other" data-cart='{"categoryId":{{ proposal.categoryId }},"proposalId":{{ proposal.id }},"priceId":{{ price.id }}}'>
                                                            Заменить в корзине
                                                        </a>
                                                    {% endif %}
                                                {% else %}
                                                    <a href="#" class="remove-from-cart" data-cart='{"categoryId":{{ proposal.categoryId }},"proposalId":{{ proposal.id }},"priceId":{{ price.id }}}'>
                                                        Убрать из корзины
                                                    </a>
                                                {% endif %}

                                                <a href="{{ path('shop_catalog_category', {'slug' : category.slug}) }}" class="show-more-proposals">
                                                    Посмотреть другие модели
                                                </a>

                                            </div>
                                        {% endif %}

                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="proposal-information-container">

                            {% if filtersResource.getProposalParameterFilters %}
                                <div class="filters-form-container">
                                    <form id="filtersForm">
                                        <ul class="tiles two_up">
                                            {% for parameterFilter in filtersResource.getProposalParameterFilters %}
                                                <li>
                                                    <div class="proposal-select">
                                                        <label for="parameter_{{ parameterFilter.getParameterId }}">
                                                            {{ parameterFilter.getName }}
                                                        </label>
                                                        <div class="picker">
                                                            <select id="parameter_{{ parameterFilter.getParameterId }}" name="parameters[{{ parameterFilter.getParameterId }}]">
                                                                <option value="-1">Не важно</option>
                                                                {% for option in parameterFilter.getOptions %}
                                                                    <option
                                                                            value="{{ option.getId }}"
                                                                            {{ option.getIsSelected ? "selected='selected'" : "" }}
                                                                            {{ option.getPricesAmount <= 0 ? "disabled='disabled'" : "" }}
                                                                            >
                                                                        {{ option.getName }} ({{ option.getPricesAmount }})
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </form>
                                </div>
                            {% endif %}

                        </div>

                        {% if proposalFeatures %}
                            <div class="large-title" style="margin-bottom: 10px">
                                Особенности модели
                            </div>
                            <table>
                                <tbody>
                                {% for parameterValue in proposalFeatures if parameterValue.id %}
                                    <tr>
                                        <td>
                                            {{ parameterValue.parameter.name }}
                                        </td>
                                        <td>
                                            {{ parameterValue.option.name }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}

                        <div class="proposal-description">
                            {{ proposal.description|nl2br }}
                        </div>

                        {% if actions %}
                            <div class="large-title">
                                Можете выбрать подарок
                            </div>
                            <div class="proposal-actions-container">
                                <div class="proposal-actions owl-carousel owl-theme">
                                    {% for action in actions %}
                                        <div class="proposal-action">
                                            <span class="proposal-action-image-container">
                                                <img src="{{ action.thumbImageUrl }}" alt="{{ action.title }}">
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% include "ShopMainBundle:Default:proposalAdditionalCategories.html.twig" %}

                    </div>

                </div>
            </div>

            <script type="text/javascript">

                $(function(){

                    var $filtersForm = $('#filtersForm, #extraFiltersForm');

                    var proposalUrl = '{{ path('shop_proposal', {'categorySlug' : category.slug, 'slug' : proposal.seoSlug|default(proposal.id)}) }}';

                    $(':input', $filtersForm).change(function(){

                        document.location = proposalUrl + '?' +$filtersForm.serialize();

                    });

                    $('.proposal-actions').owlCarousel({
                        autoPlay: 5000,
                        navigation : true,
                        pagination : false,
                        items : 3
                    });

                    $('.proposal-action-image-container').nailthumb({
                        method : 'resize'
                    });

                });

            </script>

        </div>

    </div>

{% endblock %}